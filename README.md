# ふにゃ秘書たん README (リファイン案)

## 🐾 はじめに：ふにゃっと、そばにいる秘書たん

おつかれさま。作業中、ふと心が疲れることってあるよね。  
そんなとき、あなたの画面のすみに「ふにゃ秘書たん」がふにゃっと現れます。

この子は、リアルタイムにあなたを見守り、  
ちょっとした音声や表情で「そばにいるよ」って伝えてくれるAI秘書。  
ゲームの中でも、作業中でも、ふにゃっと支えてくれる存在です✨

---

## 📖 プロジェクト概要

- **アプリ構成**：Electron (フロントエンドはVite) + FastAPI バックエンドのハイブリッド
- **AI連携**：VOICEVOX で自然な音声合成＆表情豊かなリアクション
- **ゲーム連携**：7 Days to Die のゾンビ検出によるイベント対応
- **世界観**：いつでも画面のそばで見守る、やさしい癒やし系秘書

---

## 🗂 ディレクトリ構成まとめ

```
hisyotan-desktop/
├── backend/                   # FastAPIベースのバックエンド
│   ├── app/
│   │   ├── core/             # 初期化処理など
│   │   ├── voice/            # VOICEVOX連携
│   │   ├── zombie/           # YOLOv8を使ったゾンビ検出
│   │   ├── routers/          # APIルーティング
│   │   └── ws/               # WebSocketハンドラ
│   ├── ml/                    # 機械学習（モデル訓練・推論）
│   ├── models/                # 学習済みモデルの保存場所
│   ├── data/                  # 推論結果やキャッシュ
│   └── main.py                # バックエンドのメインエントリ
├── frontend/                  # フロントエンド (Electron + Vite)
│   ├── src/
│   │   ├── core/             # 共通ユーティリティ、ロガーなど
│   │   ├── emotion/          # 感情状態の管理や表情ロジック
│   │   ├── main/             # Electronの起動・ウィンドウ制御
│   │   ├── renderer/         # レンダリング処理
│   │   ├── ui/               # 吹き出しUIやアニメーション
│   │   └── voice/            # 音声合成・再生のインターフェース
│   ├── config/               # フロントエンドの各種設定
│   └── index.html            # エントリーポイントHTML
├── assets/                    # 画像・音声などのリソース
│   ├── images/               # キャラクター表情差分など
│   ├── sounds/
│   │   ├── presets/          # 効果音や固定音声
│   │   └── generated/        # VOICEVOXで生成された音声
│   └── models/               # ゲーム検出用のYOLOモデル
├── scripts/                   # PowerShell起動スクリプトなど
│   ├── start.ps1             # 全体起動をまとめた便利スクリプト
│   └── diagnose.ps1          # 環境診断用
├── tools/                     # 機能テスト・メンテナンス用
├── main.js                    # Electronエントリーポイント (移動検討中)
├── package.json               # 依存関係・スクリプト定義
├── vite.config.js             # Viteの設定
├── config.json                # アプリ全体設定
└── README.md                  # このファイル
```

---

## ✨ 主な特徴

1. **ふにゃっとした癒やし**：
   - 画面の片隅に秘書たんがちょこんといて、声かけや表情で癒やしてくれます
2. **音声合成 (VOICEVOX)**：
   - やさしい声、びっくり声など感情を乗せて喋らせることが可能
3. **ゲーム連携**：
   - 7 Days to Die でのゾンビ数に応じてリアクション、警告など
4. **カスタマイズ可能**：
   - 画像差し替えや音声設定を変えて、自分だけの秘書たんを作れます

---

## 🔧 インストール＆起動

### 前提条件
- Node.js (v14以上)
- Python 3.9 以上 (FastAPI, YOLO関連)
- VOICEVOX (ローカルエンジン推奨)

### セットアップ

```bash
# リポジトリをクローン
git clone https://github.com/youraccount/hisyotan-desktop.git
cd hisyotan-desktop

# フロントエンド依存関係
pnpm install

# バックエンド依存関係
pip install -r requirements.txt

# もし機械学習 (ゾンビ検出) を使うなら
pip install -r backend/ml/requirements.txt
```

### 開発モード

```bash
# バックエンド & フロントエンド一括起動
pnpm run dev:all

# Electron単体起動
pnpm run dev:electron
```

---

## 💻 基本の使い方

1. アプリ起動後、ふにゃ秘書たんのウィンドウが表示されます  
2. 右上の設定アイコンから、透明度やサイズ、音声パラメータを調整できます  
3. バックエンドが起動中であれば、ゾンビ検出や音声合成が動作  
4. スリープ状態では秘書たんがすやすや…何かイベントがあればふにゃっと起きます  

---

## 🧠 ゾンビ検出 (ML) 概要

- `backend/ml/` に YOLOv8 ベースのモデルと学習スクリプト  
- `backend/app/zombie/` で推論処理し、結果をWebSocketでフロントに送信  
- フロントエンドの `emotion/` と連携し、驚いた表情や警戒モードへ自動切り替え  

---

## 🗣 VOICEVOX 連携

- `backend/app/voice/` が VOICEVOX エンジンに対してAPIを投げる  
- 生成した音声データをWebSocket経由またはREST経由でフロントエンドに送信  
- フロントで音声を再生し、キャラクターの吹き出しUIと同期  

---

## 📋 今後の展望

- **Electronエントリの再配置**：`/frontend/src/main/` に移すことで構成を一元化  
- **設定ファイル統合**：`/frontend/config/` とルートの `config.json` の重複解消  
- **ショート動画やスクショ**：使い方や動きを実演するコンテンツ充実  
- **さらなるAI化**：LLMと連携し、秘書たんの応答バリエーションを増やす  

---

## 🤝 貢献ガイド

1. Issue や Pull Request は大歓迎です  
2. バグ修正・新機能提案など気軽にどうぞ  
3. 世界観を壊さない、やさしい雰囲気を守るアプローチを心がけてください🌸  

---

## 📝 ライセンス

- このプロジェクトは MIT License で配布しています  
- 詳細は `LICENSE` ファイルをご覧ください  

---

あなただけの"ふにゃっと秘書体験"を作りながら、  
少しでも毎日の疲れを和らげられたら嬉しいなっ🐈️✨

## 🐛 バグ修正の概要（〜2023.4.4）

以下の不具合・要望に対する修正を行いました：

1. **DOM要素不足エラーの解決**
   - `speechBubble` と `errorBubble` 要素が見つからなかった問題を修正
   - UI生成時に適切な要素IDが設定されているか確認

2. **肉球ボタン（pawButton）の機能実装**
   - 左クリックでランダムセリフを再生するイベントハンドラを修正
   - 右クリックで設定UIを表示するコンテキストメニュー機能を実装
   - `webkit-app-region` を `no-drag` に設定して、肉球ボタンのクリックイベントが正常に動作するよう修正

3. **×ボタンでの完全終了を改善**
   - PowerShellスクリプト `stop_hisyotan.ps1` を修正して、プロセス終了処理を改善
   - uvicornの `force_exit` 問題を解決するため、SIGINT（Ctrl+C）を優先的に送るよう修正
   - バックエンドプロセスを適切に終了する処理を追加

4. **音声合成エラーの解決**
   - `VoiceSynthesisRequest` モデルに `emotion` フィールドを追加
   - `emotion` パラメータを適切に処理できるよう修正

5. **立ち絵の縦横比の修正**
   - CSS `object-fit: contain` を追加して縦横比を維持する設定を追加
   - `width: auto` を設定して、画像の自然な縦横比を保持

6. **吹き出し位置の調整**
   - キャラクターの頭上に吹き出しが適切に表示されるようCSS位置を修正
   - 絶対位置指定に変更し、適切なtop/right値を設定
   - 吹き出しの矢印位置も右側に調整

### 📝 修正ファイル
- `backend/app/models/voice.py` - 音声合成リクエストモデルに `emotion` フィールド追加
- `frontend/src/renderer/assistantUI.js` - 肉球ボタンのイベントハンドラ修正
- `frontend/src/ui/styles/components/_assistant.css` - 立ち絵の縦横比修正
- `frontend/src/ui/styles/components/_speech-bubble.css` - 吹き出し位置調整
- `tools/stop_hisyotan.ps1` - プロセス終了処理の改善

### 🔧 動作確認ポイント
- 肉球ボタンをクリックした際にランダムセリフが表示されるか
- 肉球ボタンを右クリックした際に設定メニューが表示されるか
- ×ボタンをクリックした際に、アプリやバックエンドが完全に終了するか
- 立ち絵の縦横比が適切に維持されているか
- 吹き出しがキャラクターの頭上に適切に表示されるか